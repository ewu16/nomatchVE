% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/nomatchVE_advanced.R
\name{nomatchVE_advanced}
\alias{nomatchVE_advanced}
\title{Advanced internal function to estimate vaccine effectiveness (VE) without matching}
\usage{
nomatchVE_advanced(
  data,
  outcome_name,
  event_name,
  trt_name,
  time_name,
  adjust_vars,
  times,
  censor_time = max(times),
  tau = 14,
  confint_type = c("wald", "percentile", "both", "none"),
  limit_type = "limit",
  n_boot = 0,
  alpha = 0.05,
  weighting = c("observed", "custom", "matched"),
  custom_weights = NULL,
  matched_dist_options = NULL,
  formula_0 = NULL,
  formula_1 = NULL,
  return_models = TRUE,
  return_boot = TRUE,
  n_cores = 1
)
}
\arguments{
\item{data}{A data frame with one row per individual containing
the columns named in \code{outcome_name}, \code{event_name}, \code{trt_name}, \code{time_name},
and any variables listed in \code{adjust_vars}.}

\item{outcome_name}{Name of the possibly-censored time-to-event variable, measured from the chosen time origin.}

\item{event_name}{Name of the event indicator. The underlying column should be numeric
(\code{1} = event, \code{0} = censored).}

\item{trt_name}{Name of the exposure indicator. The underlying column should be numeric
(\code{1} = exposed during follow-up, \code{0} = never exposed during follow-up). Exposure indicator
should indicate whether an individual is exposed while uncensored and before experiencing the endpoint of interest.}

\item{time_name}{Name of the time to exposure, measured from the chosen time origin; use \code{NA} if not exposed.}

\item{adjust_vars}{Character vector of baseline covariates to adjust for when fitting the hazard models.}

\item{times}{Numeric vector of time after exposure at which to evaluate VE. All values must be greater than tau and
should reflect meaningful clinical timepoints (e.g., 30, 60, 90 days).}

\item{censor_time}{Time after exposure at which exposed
individuals are administratively censored during model fitting. Default:
\code{max(times)}. This is used to limit borrowing of information from beyond the time period of interest.}

\item{tau}{Time after exposure (vaccination)  to exclude as part of an "immune build-up" period. Must be non-negative.
Common values may include 0 days (no delay), 7 days (one week), 14 days (two weeks) and should
match the biological understanding of when vaccine-induced immunity develops.}

\item{confint_type}{Method for constructing confidence intervals.
One of \code{"wald"}, \code{"percentile"}, or \code{"both"}.
\itemize{
\item \code{"wald"}: Computes Wald-style intervals using bootstrap standard errors.
\item \code{"percentile"}: Computes percentile bootstrap intervals.
\item \code{"both"}: Computes and returns both sets of intervals.
Default: \code{"wald"}. See \strong{Confidence intervals} section.
}}

\item{limit_type}{Character string controlling how marginalizing weights are
treated in bootstrap samples. One of:
\itemize{
\item \code{"limit"} (default): re-estimate marginalizing distributions in each bootstrap sample,
providing valid inference under the assumption that the marginalizing distributions
converge to a population limit;
\item \code{"fixed"}: treat marginalizing distributions as fixed across bootstrap samples.
When \code{weighting = "custom"}, \code{limit_type} is automatically set to \code{"fixed"}.
}}

\item{n_boot}{Number of bootstrap replicates for confidence intervals.
Recommended to use at least 1000 for publication-quality results. Use smaller values (e.g., 10-100) for initial exploration.
Default: \code{0} (no bootstrapping).}

\item{alpha}{Significance level for confidence intervals (Confidence level = 100*(1-\code{alpha})\%). Default: \code{0.05}.}

\item{weighting}{Character string specifying how to construct marginalizing weights.
#'   One of:
\itemize{
\item \code{"observed"} (default): estimate weights from the observed data;
\item \code{"custom"}: use user-specified weights provided via \code{custom_weights} argument;
\item \code{"matched"}: estimate weights from a matched cohort (for historical purposes).
}}

\item{custom_weights}{a \code{list(g_dist, p_dist)} providing custom weights for marginalization.
Must have the following format:
\itemize{
\item \code{g_dist}: data frame with columns
\itemize{
\item \code{time_name} (time of exposure),
\item all variables in \code{adjust_vars}
\item \code{group_name} (unique identifier for each covariate-group),
\item \code{prob} (probability of exposure at the given time within the covariate-group. Should sum to 1 within each covariate-group)
}
\item \code{p_dist}: data frame with columns
\itemize{
\item all variables in \code{adjust_vars}
\item \code{prob} (probability of covariate-group. Should sum to 1 over all covariate groups.)
}
}}

\item{matched_dist_options}{If \code{weighting = "matched"}, a list of
options created by \code{\link[=matched_dist]{matched_dist()}} controlling how the matched dataset
is used to estimate the marginalizing distributions.}

\item{formula_0}{Either a formula or a pre-fit \code{coxph} model object for the
unvaccinated hazard (calendar-time scale). If a fitted model is provided,
it will be used directly instead of fitting a new model. Intended for advanced use.}

\item{formula_1}{Either a formula or a pre-fit  \code{coxph} model object for the
vaccinated hazard (time-since-vaccination scale). If a fitted model is provided,
it will be used directly instead of fitting a new model. Intended for advanced use.}

\item{return_models}{Logical; return fitted conditional hazard models?
Default: \code{TRUE}.}

\item{return_boot}{Logical; return bootstrap draws in \code{boot_samples}?
Default: \code{TRUE}. Must be set to \code{TRUE} if user plans to use \code{\link[=add_simultaneous_ci]{add_simultaneous_ci()}}
to obtain simultaneous confidence intervals.}

\item{n_cores}{Integer; parallel cores for bootstrapping. Passed to
\code{parallel::mclapply} as \code{mc.cores}. On Unix-like OS only; not available on
Windows. Default: \code{1}.}
}
\value{
An object of class \code{vefit} containing:
\describe{
\item{estimates}{List of matrices: \code{cuminc_0}, \code{cuminc_1}, \code{ve}.
Each matrix has rows corresponding to \code{times} and columns containing point estimates and confidence intervals.}
\item{gp_list}{List with dataframes \code{g_dist}, \code{p_dist} used for marginalization.}
\item{model_0}{Fitted hazard model under no exposure.}
\item{model_1}{Fitted hazard model under exposure .}
\item{n_success_boot}{Numeric vector with length equal to \code{length(times)}:
indicates number of successful bootstrap replications per timepoint.}
\item{boot_samples}{(If \code{return_boot = TRUE}) list of matrices with bootstrap
estimates; rows = bootstrap iterations, cols = \code{times}.}
}

The \code{vefit} object has methods for \code{\link[=print]{print()}}, \code{\link[=summary]{summary()}}, and \code{\link[=plot]{plot()}}.
Use \code{\link[=add_simultaneous_ci]{add_simultaneous_ci()}} to add simultaneous confidence intervals.
}
\description{
\strong{Internal function for backward compatibility and advanced use cases.}

\code{nomatchVE_advanced()} provides additional flexibility compared to \code{\link[=nomatchVE]{nomatchVE()}},
including additional weighting options based on matching and more control over the estimation/inference procedure.
Most users should use \code{\link[=nomatchVE]{nomatchVE()}} instead.
}
\details{
\strong{Modeling.} Two Cox models are fit: one over the chosen time scale among the
not-yet-exposed, and one over time-since-exposure among the exposed who remain
at-risk \code{tau} days after exposure. For the exposed hazard model, exposure time is included as a natural cubic
spline with 4 degrees of freedom. Predictions are combined via G-computation and
marginalized.

\strong{Marginalizing weights.} When \code{weighting = observed}, the marginalizing weights
are the empirical distributions of exposure times and covariates among the exposed who remain
at-risk \code{tau} days after exposure. These weights are returned in the \code{vefit} object under \code{gp_list}.
They can also be obtained prior to the call to \code{nomatchVE()} by calling \code{get_observed_weights()}.

\strong{Confidence intervals.} Wald CIs are constructed on transformed scales:
logit for cumulative incidence; \code{log(1 - VE)} for VE, using bootstrap SEs,
then back-transformed.

\strong{Parallelization.} Bootstraps can be parallelized on Unix via \code{\link[parallel:mclapply]{parallel::mclapply()}}
by providing \code{n_cores} argument.
}
\section{Differences from nomatchVE()}{

This advanced version provides:
\itemize{
\item Support for pre-fitted model objects (for debugging or specialized analyses)
\item Legacy support for matched weighting approach
\item Explicit control of marginalizing weights in bootstrapping procedure
}

For standard analyses, \code{\link[=nomatchVE]{nomatchVE()}} provides a simpler interface with sensible defaults.
}

\keyword{internal}
