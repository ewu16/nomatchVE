---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# R/`nomatchVE` 

> A matching alternative for more efficiently evaluating vaccine effectiveness using observational data

<!-- badges: start -->
<!-- badges: end -->

## Description

The `nomatchVE` package uses a G-computation style estimator to compute vaccine efficacy from observational vaccine studies. The proposed estimator tends to produce similar point estimates as matching-based
estimators but is more efficient. 

## Installation

You can install the development version of `nomatchVE` like so:

``` r
# TODO: not yet available on Github 
# install.packages("devtools")
devtools::install_github("ewu16/nomatchVE")
```

## Example

This minimal example shows how to use `nomatchVE` to obtain cumulative incidence
and vaccine effectiveness estimates in a simple simulated data set. 

```{r example, fig.width = 8, fig.height = 4}
library(nomatchVE)
# Set seed for reproducibility 
set.seed(1234)

# ------------------------------------------------------------------------------
# Example data
head(simdata)
summary(simdata)

# ------------------------------------------------------------------------------
# 1. Set input parameters
outcome_name <- "Y"
event_name <- "event"
trt_name <- "V"
time_name <- "D_obs"
adjust_vars <- c("x1", "x2")

times <- seq(30, 180, by = 30)
censor_time <- max(times)
tau <- 14
ci_type <- "wald"
n_boot <- 10
alpha <- .05

# ------------------------------------------------------------------------------
# 2. Compute VE estimand at time points 

fit1 <- nomatchVE(data = simdata,
              outcome_name = outcome_name,
              event_name = event_name,
              trt_name = trt_name,
              time_name = time_name, 
              adjust_vars = adjust_vars,
              times = times,
              censor_time = censor_time, 
              tau = tau,
              ci_type = ci_type,
              n_boot = n_boot, 
              alpha = alpha)
             
fit1$estimates

#Plot pointwise intervals 
plot_ve_panel(fit1 , ci_type = "wald") 

#Compute simultaneous CI
simul_ci <- simultaneous_ci(fit1, alpha, seed = 1234)
simul_ci$estimates

#Plot simultaneous confidence bands 
plot_ve_panel(simul_ci , ci_type = "simul") 

 


# ------------------------------------------------------------------------------
# 3. Compare results with matching estimator

id_name <- "ID"
matching_vars <- adjust_vars

matched_cohort <- match_rolling_cohort(data = simdata,
                                       outcome_name = outcome_name,
                                       trt_name = trt_name,
                                       time_name = time_name,
                                       id_name = id_name,
                                       matching_vars = adjust_vars,
                                       replace = FALSE,
                                       seed = 5678)

matched_data <- matched_cohort[[1]]


fit_matching <-matching_ve(matched_data = matched_data,
                           outcome_name = outcome_name,
                           event_name = event_name,
                           trt_name = trt_name,
                           time_name = time_name,
                           method = "km",
                           times = times,
                           censor_time = censor_time,
                           tau = tau,
                           ci_type = ci_type,
                           n_boot = n_boot,
                           alpha = alpha) 
   

## Proposed and matching based estimators have similar point estimates
##  Proposed has narrower confidence intervals 
fit1$estimates
fit_matching$estimates
```



```{r, eval = FALSE, include = FALSE}

#proposed with matching marginalizing distribution 

fit2 <- nomatchVE(data = simdata,
              outcome_name = outcome_name,
              event_name = event_name,
              trt_name = trt_name,
              time_name = time_name,
              adjust_vars = adjust_vars,
              marginalizing_dist = "matched",
              matched_dist_options = matched_dist(matched_data = matched_data,
                                                  pair_censoring = TRUE),
              times = times,
              censor_time = censor_time, 
              tau = tau,
              ci_type = ci_type,
              limit_type =  limit_type,
              n_boot = n_boot, 
              alpha = alpha)


## Either choice of marginalizing distribution leads to similar estimates
fit1$estimates

fit2$estimates


```

