---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# R/`obsve` 

> Estimate vaccine effectiveness in observational studies: a matching alternative

<!-- badges: start -->
<!-- badges: end -->

## Description

The `obsve` package uses a G-computation style estimator to compute vaccine efficacy from observational vaccine studies. The proposed estimator tends to produce similar point estimates as matching-based
estimators but is more efficient. 

## Installation

You can install the development version of `obsve` like so:

``` r
# TODO: not yet available on Github 
# install.packages("devtools")
devtools::install_github("ewu16/obsve")
```

## Example

This minimal example shows how to use `obsve` to obtain cumulative incidence
and vaccine effectiveness estimates in a simple simulated data set. 

```{r example}
library(obsve)
# Set seed for reproducibility 
set.seed(1234)

# ------------------------------------------------------------------------------
# Example data
head(simdata)
summary(simdata)

# ------------------------------------------------------------------------------
# 1. Set input parameters
outcome_name <- "Y"
event_name <- "event"
trt_name <- "V"
time_name <- "D_obs"
adjust_vars <- c("x1", "x2")

t0 <- 90
censor_time <- 90
tau <- 14
ci_type <- "wald"
limit_type <- "fixed"
n_boot <- 10
alpha <- .05

# ------------------------------------------------------------------------------
# 2. Compute VE estimand at t0 

## 2a. Use observed distribution of vaccination dates/covariates

fit1 <- obsve(data = simdata,
              outcome_name = outcome_name,
              event_name = event_name,
              trt_name = trt_name,
              time_name = time_name, 
              adjust_vars = adjust_vars,
              marginalizing_dist = "observed",
              t0 = t0,
              censor_time = censor_time, 
              tau = tau,
              ci_type = ci_type,
              limit_type =  limit_type,
              n_boot = n_boot, 
              alpha = alpha)
              
             
fit1$estimates



## 2b. Use distribution of vaccination dates/covariates from matched data set 

### Create matched dataset to pass as additional argument to `obsve()`
id_name <- "ID"
matching_vars <- adjust_vars

matched_cohort <- match_rolling_cohort(data = simdata,
                                       outcome_name = outcome_name,
                                       trt_name = trt_name,
                                       time_name = time_name,
                                       id_name = id_name,
                                       matching_vars = adjust_vars,
                                       replace = FALSE,
                                       seed = 5678)

matched_data <- matched_cohort[[1]]

fit2 <- obsve(data = simdata,
              outcome_name = outcome_name,
              event_name = event_name,
              trt_name = trt_name,
              time_name = time_name,
              adjust_vars = adjust_vars,
              marginalizing_dist = "matched",
              matched_dist_options = matched_dist(matched_data = matched_data,
                                                  pair_censoring = TRUE),
              t0 = t0,
              censor_time = censor_time, 
              tau = tau,
              ci_type = ci_type,
              limit_type =  limit_type,
              n_boot = n_boot, 
              alpha = alpha)


## Either choice of marginalizing distribution leads to similar estimates
fit1$estimates

fit2$estimates

# ------------------------------------------------------------------------------
# 3. Compute VE at additional timepoints if desired 

times <- c(30, 60, 90)
results1 <- timepoints(fit1, times = times)
results1$estimates

results2 <- timepoints(fit2, times = times)


# ------------------------------------------------------------------------------
# 4. Compare results with matching estimator

fit_matching <-matching_ve(matched_data = matched_data,
                           outcome_name = outcome_name,
                           event_name = event_name,
                           trt_name = trt_name,
                           time_name = time_name,
                           adjust = adjust_vars,
                           times = times,
                           censor_time = censor_time,
                           tau = tau,
                           pair_censoring = TRUE,
                           separate = TRUE,
                           ci_type = ci_type,
                           limit_type = limit_type,
                           data = simdata,
                           id_name = id_name,
                           matching_vars = matching_vars,
                           n_boot = n_boot,
                           alpha = alpha) 
   

## Proposed and matching based estimators have similar point estimates
##  Proposed has narrower confidence intervals 
results1$estimates

fit_matching$estimates
```

